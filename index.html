<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <!-- PWA ESSENTIALS -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#000000">
    
    <!-- MANIFEST -->
    <link rel="manifest" href="manifest.json">
    
    <!-- FAVICON (obrigat√≥rio) -->
    <link rel="icon" type="image/png" href="icon-192.png">
    
    <title>Mesa Ui24R</title>
    
    <style>
        /* ZERA TUDO */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body, html {
            width: 100%;
            height: 100%;
            overflow: hidden;
            background: #000;
            font-family: Arial, sans-serif;
        }
        
        /* IFRAME */
        iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: none;
            z-index: 1;
        }
        
        /* BOT√ÉO DE INSTALA√á√ÉO FIXO */
        .install-button {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        /* LOADING */
        .loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 2;
            transition: opacity 0.3s;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255,255,255,0.1);
            border-top-color: #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* MODAL DE INSTALA√á√ÉO */
        .install-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1001;
            color: white;
            text-align: center;
            padding: 20px;
        }
        
        .modal-content {
            background: #222;
            padding: 30px;
            border-radius: 15px;
            max-width: 90%;
        }
        
        .steps {
            text-align: left;
            margin: 20px 0;
            font-size: 14px;
            color: #aaa;
        }
        
        .step {
            margin: 10px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .step-num {
            background: #667eea;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <!-- Loading -->
    <div class="loader" id="loader">
        <div class="spinner"></div>
        <div style="color: #aaa; font-size: 14px;">Carregando...</div>
    </div>
    
    <!-- Bot√£o flutuante de instala√ß√£o -->
    <button class="install-button" id="installFloatBtn" title="Instalar App">üì≤</button>
    
    <!-- Modal de instru√ß√µes -->
    <div class="install-modal" id="installModal">
        <div class="modal-content">
            <h2>üì± Instalar App da Mesa</h2>
            <p>Para instalar como app e ter tela cheia:</p>
            
            <div class="steps">
                <div class="step">
                    <div class="step-num">1</div>
                    <span>No Chrome, toque nos 3 pontos ‚ãÆ</span>
                </div>
                <div class="step">
                    <div class="step-num">2</div>
                    <span>Selecione "Instalar app" ou "Adicionar √† tela inicial"</span>
                </div>
                <div class="step">
                    <div class="step-num">3</div>
                    <span>Confirme o nome: <strong>Mesa Ui24R</strong></span>
                </div>
                <div class="step">
                    <div class="step-num">4</div>
                    <span>Pronto! Agora tem um √≠cone na tela inicial üéõÔ∏è</span>
                </div>
            </div>
            
            <button id="closeModal" style="
                background: #667eea;
                color: white;
                border: none;
                padding: 12px 30px;
                border-radius: 25px;
                font-size: 16px;
                cursor: pointer;
                margin-top: 20px;
            ">
                Entendi, Fechar
            </button>
        </div>
    </div>
    
    <!-- Iframe da mesa -->
    <iframe 
        src="http://192.168.1.249" 
        id="mesaFrame"
        allow="autoplay; microphone; fullscreen"
    ></iframe>
    
    <script>
        // ========== ELEMENTOS ==========
        const loader = document.getElementById('loader');
        const installFloatBtn = document.getElementById('installFloatBtn');
        const installModal = document.getElementById('installModal');
        const closeModal = document.getElementById('closeModal');
        const mesaFrame = document.getElementById('mesaFrame');
        
        // ========== VARI√ÅVEIS PWA ==========
        let deferredPrompt = null;
        let isInstalled = false;
        
        // ========== INICIALIZA√á√ÉO ==========
        document.addEventListener('DOMContentLoaded', () => {
            console.log('PWA Ui24R iniciado');
            
            // Verificar se j√° √© PWA
            if (window.matchMedia('(display-mode: standalone)').matches) {
                console.log('‚úÖ J√° est√° rodando como PWA');
                isInstalled = true;
                installFloatBtn.style.display = 'none';
            }
            
            // Esconder loader ap√≥s 2s
            setTimeout(() => {
                loader.style.opacity = '0';
                setTimeout(() => {
                    loader.style.display = 'none';
                }, 300);
            }, 2000);
        });
        
        // ========== BOT√ÉO FLUTUANTE ==========
        installFloatBtn.addEventListener('click', () => {
            if (deferredPrompt && !isInstalled) {
                // Tenta instala√ß√£o autom√°tica
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('‚úÖ Usu√°rio instalou o PWA');
                        isInstalled = true;
                        installFloatBtn.style.display = 'none';
                    } else {
                        // Se recusou, mostra instru√ß√µes manuais
                        installModal.style.display = 'flex';
                    }
                    deferredPrompt = null;
                });
            } else {
                // Mostra instru√ß√µes manuais
                installModal.style.display = 'flex';
            }
        });
        
        // ========== EVENTO PWA AUTOM√ÅTICO ==========
        window.addEventListener('beforeinstallprompt', (e) => {
            console.log('üéØ beforeinstallprompt DISPARADO!');
            e.preventDefault();
            deferredPrompt = e;
            
            // Mostra bot√£o ap√≥s 5 segundos
            setTimeout(() => {
                if (!isInstalled) {
                    installFloatBtn.style.display = 'flex';
                }
            }, 5000);
        });
        
        window.addEventListener('appinstalled', () => {
            console.log('‚úÖ PWA instalado com sucesso');
            isInstalled = true;
            installFloatBtn.style.display = 'none';
        });
        
        // ========== MODAL ==========
        closeModal.addEventListener('click', () => {
            installModal.style.display = 'none';
        });
        
        // Fecha modal ao clicar fora
        installModal.addEventListener('click', (e) => {
            if (e.target === installModal) {
                installModal.style.display = 'none';
            }
        });
        
        // ========== FULLSCREEN AUTOM√ÅTICO ==========
        setTimeout(() => {
            if (document.documentElement.requestFullscreen) {
                document.documentElement.requestFullscreen();
            }
        }, 1000);
        
        // ========== SERVICE WORKER (OBRIGAT√ìRIO PARA PWA) ==========
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                // Registra service worker b√°sico
                navigator.serviceWorker.register('sw.js')
                    .then(reg => {
                        console.log('‚úÖ Service Worker registrado:', reg);
                    })
                    .catch(err => {
                        console.log('‚ùå Service Worker falhou:', err);
                        // Cria service worker dinamicamente se n√£o existir
                        createDynamicServiceWorker();
                    });
            });
        }
        
        function createDynamicServiceWorker() {
            const swCode = `
                self.addEventListener('install', event => {
                    console.log('üì¶ Service Worker instalado');
                });
                self.addEventListener('fetch', event => {
                    // N√£o faz cache, s√≥ passa adiante
                    return fetch(event.request);
                });
            `;
            
            const blob = new Blob([swCode], { type: 'application/javascript' });
            const swURL = URL.createObjectURL(blob);
            
            navigator.serviceWorker.register(swURL)
                .then(() => console.log('‚úÖ SW din√¢mico registrado'))
                .catch(e => console.log('‚ùå SW din√¢mico falhou:', e));
        }
        
        // ========== DETECTA SE √â ANDROID ==========
        function isAndroid() {
            return /Android/i.test(navigator.userAgent);
        }
        
        // Android: for√ßa modo desktop para melhor compatibilidade
        if (isAndroid()) {
            setTimeout(() => {
                const meta = document.createElement('meta');
                meta.name = 'viewport';
                meta.content = 'width=1200, initial-scale=0.5';
                document.head.appendChild(meta);
            }, 3000);
        }
    </script>
</body>
</html>
